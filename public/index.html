<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriSynth アプリケーション</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="wrapper">
        <div id="selection-screen" class="step active">
            <h2>アプリケーションを選択</h2>
            <p>利用したい機能を選択してください。</p>
            <button id="select-refresh-btn" class="selection-btn">NutriRefresh<br><small>（失われた栄養の再現）</small></button>
            <button id="select-restore-btn" class="selection-btn">NutriRestore<br><small>（調理で失われた栄養の復元）</small></button>
            <button id="select-replace-btn" class="selection-btn">NutriReplace<br><small>（食材の栄養的代替）</small></button>
        </div>

        <div id="nutri-refresh-app" class="step">
            <h2>NutriRefresh: 失われた栄養の再現</h2>
            <p style="text-align: left; font-size: 14px; margin-bottom: 20px;">
                調理や保存によって失われた栄養素を推定します。対象の食品と、調理後の経過時間を選択してください。
            </p>
            <div class="input-group">
                <label for="refresh-food-select">食品の選択:</label>
                <select id="refresh-food-select"
                    style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                    <option value="マグロ">マグロ</option>
                    <option value="ほうれん草">ほうれん草</option>
                </select>
            </div>
            <div class="input-group">
                <label for="refresh-food-amount">量 (g):</label>
                <input type="number" id="refresh-food-amount" min="1" value="100"
                    style="width: 100%; box-sizing: border-box; padding: 8px;">
            </div>
            <div class="input-group">
                <label for="refresh-temperature">保存温度 (℃):</label>
                <input type="number" id="refresh-temperature" min="-30" max="60" value="4"
                    style="width: 100%; box-sizing: border-box; padding: 8px;">
            </div>
            <div class="input-group">
                <label for="refresh-elapsed-time">経過時間 (時間):</label>
                <input type="number" id="refresh-elapsed-time" min="1" value="24"
                    style="width: 100%; box-sizing: border-box; padding: 8px;">
            </div>
            <button id="refresh-calculate-btn" style="width: 100%;">失われた栄養素を計算</button>
            <div id="refresh-result-area" style="margin-top: 20px; text-align: left;">
                <p>ここに推定結果が表示されます。</p>
            </div>
            <button id="refresh-supplement-btn" style="display: none;">NutriSynthから補給する</button>
            <button class="back-btn" data-target="selection-screen">機能選択に戻る</button>
        </div>

        <div id="nutri-restore-app" class="step">
            <h2>NutriRestore: 調理で失われた栄養の復元</h2>
            <p style="text-align: left; font-size: 14px; margin-bottom: 20px;">
                調理によって失われがちな栄養素を推定します。対象の食品と調理方法を選択してください。
            </p>
            <div class="input-group">
                <label for="restore-food-select">食品の選択:</label>
                <select id="restore-food-select"
                    style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                    <option value="マグロ">マグロ</option>
                    <option value="ほうれん草">ほうれん草</option>
                </select>
            </div>
            <div class="input-group">
                <label for="restore-cooking-method">調理方法の選択:</label>
                <select id="restore-cooking-method"
                    style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                    <option value="焼く">焼く</option>
                    <option value="煮る">煮る</option>
                    <option value="揚げる">揚げる</option>
                </select>
            </div>
            <div class="input-group">
                <label for="restore-temperature">調理温度 (℃):</label>
                <input type="number" id="restore-temperature" min="30" max="200" value="100"
                    style="width: 100%; box-sizing: border-box; padding: 8px;">
            </div>
            <div class="input-group">
                <label for="restore-time">経過時間 (分):</label>
                <input type="number" id="restore-time" min="1" value="20"
                    style="width: 100%; box-sizing: border-box; padding: 8px;">
            </div>
            <button id="restore-calculate-btn" style="width: 100%;">失われた栄養素を計算</button>
            <div id="restore-result-area" style="margin-top: 20px; text-align: left;">
                <p>ここに推定結果が表示されます。</p>
            </div>
            <button id="restore-supplement-btn" style="display: none;">NutriSynthから補給する</button>
            <button class="back-btn" data-target="selection-screen">機能選択に戻る</button>
        </div>

        <div id="nutri-replace-app" class="step">
            <h2>NutriReplace: 食材の栄養的代替</h2>
            <p style="text-align: left; font-size: 14px; margin-bottom: 20px;">
                特定の食材を避ける場合、その食材に含まれる栄養素を代替します。
            </p>
            <div class="input-group">
                <label for="replace-recipe-select">レシピの選択:</label>
                <select id="replace-recipe-select"
                    style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                    <option value="グリーンスムージー">グリーンスムージー</option>
                </select>
            </div>
            <div class="input-group">
                <label for="replace-ingredient-select">除外する食材:</label>
                <select id="replace-ingredient-select"
                    style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                    <option value="ほうれん草">ほうれん草</option>
                </select>
            </div>
            <button id="replace-calculate-btn" style="width: 100%;">代替する栄養素を計算</button>
            <div id="replace-result-area" style="margin-top: 20px; text-align: left;">
                <p>ここに推定結果が表示されます。</p>
            </div>
            <button id="replace-supplement-btn" style="display: none;">NutriSynthから代替栄養素を添加する</button>
            <button class="back-btn" data-target="selection-screen">機能選択に戻る</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const screens = {
                selection: document.getElementById('selection-screen'),
                refresh: document.getElementById('nutri-refresh-app'),
                restore: document.getElementById('nutri-restore-app'),
                replace: document.getElementById('nutri-replace-app')
            };

            // --- 画面切り替えロジック ---
            const showScreen = (screenId) => {
                Object.values(screens).forEach(screen => screen.classList.remove('active'));
                screens[screenId].classList.add('active');
            };

            document.getElementById('select-refresh-btn').addEventListener('click', () => showScreen('refresh'));
            document.getElementById('select-restore-btn').addEventListener('click', () => showScreen('restore'));
            document.getElementById('select-replace-btn').addEventListener('click', () => showScreen('replace'));

            document.querySelectorAll('.back-btn').forEach(button => {
                button.addEventListener('click', () => showScreen('selection'));
            });

            // --- API通信を管理する汎用関数 ---
            async function postToApi(endpoint, body) {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'サーバーとの通信に失敗しました。');
                }
                return response.json();
            }

            // --- 結果表示用の共通関数 ---
            function displayNutrientResults(resultArea, resultData, title) {
                const unitMap = {
                    'カルシウム': 'mg', '鉄': 'mg', 'ビタミンA': 'μg', 'ビタミンD': 'μg',
                    'ビタミンB1': 'mg', 'ビタミンB2': 'mg', 'ビタミンB6': 'mg', 'ビタミンB12': 'μg',
                };

                let resultHTML = `<h3>${title}</h3><ul>`;
                for (const [nutrient, amount] of Object.entries(resultData)) {
                    const unit = unitMap[nutrient] || '';
                    resultHTML += `<li style="color: red; font-weight: bold;">${nutrient}: ${(amount || 0).toFixed(2)} ${unit}</li>`;
                }
                resultHTML += '</ul>';
                resultArea.innerHTML = resultHTML;
            }

            function formatSupplementMessage(data, actionText) {
                const unitMap = {
                    'カルシウム': 'mg', '鉄': 'mg', 'ビタミンA': 'μg', 'ビタミンD': 'μg',
                    'ビタミンB1': 'mg', 'ビタミンB2': 'mg', 'ビタミンB6': 'mg', 'ビタミンB12': 'μg',
                };
                let message = `NutriSynthへの送信シミュレーション:\n以下の栄養素を${actionText}します:\n`;
                for (const [nutrient, amount] of Object.entries(data)) {
                    const unit = unitMap[nutrient] || '';
                    message += `- ${nutrient}: ${(amount || 0).toFixed(2)} ${unit}\n`;
                }
                return message;
            }

            // --- NutriRefresh ロジック ---
            const refreshCalcBtn = document.getElementById('refresh-calculate-btn');
            const refreshResultArea = document.getElementById('refresh-result-area');
            const refreshSupplementBtn = document.getElementById('refresh-supplement-btn');
            let refreshDataToSupplement = null;

            refreshCalcBtn.addEventListener('click', async () => {
                const foodSelect = document.getElementById('refresh-food-select');
                const amountInput = document.getElementById('refresh-food-amount');
                const temperatureInput = document.getElementById('refresh-temperature');
                const timeInput = document.getElementById('refresh-elapsed-time');
                const foodName = foodSelect.options[foodSelect.selectedIndex].text;
                const elapsedTime = parseFloat(timeInput.value);
                const amount = parseFloat(amountInput.value);
                const temperature = parseFloat(temperatureInput.value);

                if (isNaN(elapsedTime) || elapsedTime < 0) {
                    refreshResultArea.innerHTML = '<p style="color: red;">有効な経過時間を入力してください。</p>';
                    return;
                }

                refreshResultArea.innerHTML = '<p>GPTが計算中...</p>';
                refreshSupplementBtn.style.display = 'none';

                try {
                    const result = await postToApi('/api/refresh', { foodName, elapsedTime, amount, temperature });
                    refreshDataToSupplement = result;
                    displayNutrientResults(refreshResultArea, result, `失われた栄養素`);
                    refreshSupplementBtn.style.display = 'block';
                } catch (error) {
                    refreshResultArea.innerHTML = `<p style="color: red;">エラー: ${error.message}</p>`;
                }
            });

            refreshSupplementBtn.addEventListener('click', () => {
                if (!refreshDataToSupplement) return;
                alert(formatSupplementMessage(refreshDataToSupplement, '補給'));
            });


            // --- NutriRestore ロジック ---
            const restoreCalcBtn = document.getElementById('restore-calculate-btn');
            const restoreResultArea = document.getElementById('restore-result-area');
            const restoreSupplementBtn = document.getElementById('restore-supplement-btn');
            let restoreDataToSupplement = null;

            restoreCalcBtn.addEventListener('click', async () => {
                const foodSelect = document.getElementById('restore-food-select');
                const methodSelect = document.getElementById('restore-cooking-method');
                const temperatureInput = document.getElementById('restore-temperature');
                const timeInput = document.getElementById('restore-time');
                const foodName = foodSelect.options[foodSelect.selectedIndex].text;
                const cookingMethod = methodSelect.options[methodSelect.selectedIndex].text;
                const temperature = parseFloat(temperatureInput.value);
                const time = parseFloat(timeInput.value);

                restoreResultArea.innerHTML = '<p>GPTが計算中...</p>';
                restoreSupplementBtn.style.display = 'none';

                try {
                    const result = await postToApi('/api/restore', { foodName, cookingMethod, temperature, time });
                    restoreDataToSupplement = result;
                    displayNutrientResults(restoreResultArea, result, '失われた栄養素');
                    restoreSupplementBtn.style.display = 'block';
                } catch (error) {
                    restoreResultArea.innerHTML = `<p style="color: red;">エラー: ${error.message}</p>`;
                }
            });

            restoreSupplementBtn.addEventListener('click', () => {
                if (!restoreDataToSupplement) return;
                alert(formatSupplementMessage(restoreDataToSupplement, '復元'));
            });


            // --- NutriReplace ロジック ---
            const replaceCalcBtn = document.getElementById('replace-calculate-btn');
            const replaceResultArea = document.getElementById('replace-result-area');
            const replaceSupplementBtn = document.getElementById('replace-supplement-btn');
            let replaceDataToSupplement = null;

            replaceCalcBtn.addEventListener('click', async () => {
                const recipeSelect = document.getElementById('replace-recipe-select');
                const ingredientSelect = document.getElementById('replace-ingredient-select');
                const recipeName = recipeSelect.options[recipeSelect.selectedIndex].text;
                const ingredientName = ingredientSelect.options[ingredientSelect.selectedIndex].text;

                replaceResultArea.innerHTML = '<p>GPTが計算中...</p>';
                replaceSupplementBtn.style.display = 'none';

                try {
                    const result = await postToApi('/api/replace', { recipeName, ingredientName });
                    replaceDataToSupplement = result;
                    displayNutrientResults(replaceResultArea, result, `「${ingredientName}」の代替栄養素`);
                    replaceSupplementBtn.style.display = 'block';
                } catch (error) {
                    replaceResultArea.innerHTML = `<p style="color: red;">エラー: ${error.message}</p>`;
                }
            });

            replaceSupplementBtn.addEventListener('click', () => {
                if (!replaceDataToSupplement) return;
                alert(formatSupplementMessage(replaceDataToSupplement, '代替'));
            });
        });
    </script>
</body>

</html>